# Scaling Law with Learning Rate Annealing — 논문 정리

## 메타정보

* **제목:** Scaling Law with Learning Rate Annealing
* **저자:** Howe Tissue, Venus Wang, Lu Wang
* **arXiv:** 2408.11029 (v2)
* **핵심 제안:** 학습률(LR) 스케줄러에 따른 **전체 학습 과정의 검증 손실 곡선**을 한 식으로 설명하는 새로운 스케일링 법칙

---

## TL;DR

이 논문은 전통적인 스케일링 법칙이 **학습 종료 시점의 단일 손실값**만 설명하던 한계를 넘어, **학습 전 단계의 손실 곡선 전체**를 설명·예측하는 공식을 제안한다. 핵심은 두 면적: (1) **전진 면적** $S_1$ = LR 곡선 아래 누적 합, (2) **어닐링 면적** $S_2$ = LR 감소(혹은 재웜업 증가)의 **모멘텀을 가중 합**으로 반영한 항. 제안식은 다양한 LRS(상수, 코사인, WSD, cyclic 등)와 여러 모델/하이퍼파라미터에서 높은 적합도(R²≈0.999)를 보이며, 적은 학습 곡선만으로 **미래 손실 곡선과 다른 스케줄**을 정확히 예측한다. 또한 모델 크기 $N$까지 포함하는 확장식도 제시하여, **어닐링 이득이 모델 규모와 함께 증가**함을 보인다. (도해: p.2의 Fig.1에서 $S_1,S_2$ 면적 설명; p.3 Fig.2 적합, p.4 Fig.3 예측 사례).&#x20;

---

## 연구 목적

* LR 스케줄 변경으로 생기는 \*\*국부적 손실 하강(annealing drop)\*\*까지 포함해 **학습 전 구간 손실 동역학**을 정밀 모델링
* **적은 비용**(한두 개 곡선으로도 가능)으로 스케일링 법칙을 **정확**하고 **표현력 있게** 적합/예측
* 기존 경험적 관찰(코사인 주기/최소 LR, WSD의 이점, CPT 재웜업 등)에 **이론적 설명** 제공

---

## 배경

* 전통적 스케일링 법칙(예: Chinchilla)은 **데이터/모델 크기**에 대한 **최종 손실**의 멱함수 관계만을 적합한다.
* 실제 학습에서는 LR **어닐링 구간에서 손실이 급강하**하는 현상이 빈번하나, 기존 공식은 이 **시간적 구조**를 반영하지 못함. (유사 곡선: p.5 Fig.4에서 LR–gradient norm–loss의 형상 유사성)

---

## 핵심 공식(방법론)

### 1) 기본식 (학습 단계 s에서의 손실)

$$
L(s) \;=\; L_0 + A\cdot S_1^{-\alpha} \;-\; C\cdot S_2
$$

* $S_1=\sum_{i=1}^{s}\eta_i$ (**summed LR**, 전진 면적): 파라미터 업데이트 **총량**에 대응
* $S_2=\sum_{i=1}^{s}\sum_{k=1}^{i}(\eta_{k-1}-\eta_k)\,\lambda^{\,i-k}$ (**annealing area**, 모멘텀 누적): \*\*LR 감소(>0) / 재웜업(<0)\*\*의 **지연 효과**(momentum)를 반영
* $\lambda\in[0.99,0.999]$: 어닐링 모멘텀의 **감쇠 계수**
* $L_0,A,C,\alpha>0$: 데이터·설정 고정 시 상수
* **직관**: $S_1$은 전역적 멱법칙 하강(“미끄럼틀을 내려감”), $S_2$는 어닐링이 낳는 **추가 하강 진폭 감쇠**(내벽에서 진동이 줄어드는 효과). (개념 그림: p.7 가운데 도해)

### 2) 모델 규모 $N$까지 확장

$$
L(s,N) \;=\; L_0 + A\cdot S_1^{-\alpha} + B\cdot N^{-\beta} \;-\; C\cdot S_2 \cdot N^{\gamma}
$$

* **어닐링 이득**이 **모델 크기**에 따라 **스케일**된다는 실증 결과를 반영($S_2\propto N^\gamma$; p.9 Fig.7)

---

## 실험 설정

* **데이터**: Train = **FineWeb**, Val = **RedPajama-CC**
* **모델**: LLaMA 유사 구조(594M non-embed 파라미터) 중심, 추가로 293M, 1.7B 등 다양한 크기 및 **MoE(8×106M, top-k=2)** 실험 포함
* **최적화**: AdamW(β₁=0.9, β₂=0.95), weight decay=0.1, grad clip=1.0
* **배치**: 4M tokens, **LR max**=2e-4, **warmup**=500 (warmup 시 $S_1,S_2$ 계산은 $\eta_\text{max}$로 간주)
* **스케줄**: 상수, 코사인, **WSD**(warmup-stable-decay; 마지막 구간만 어닐링), multi-step cosine, cyclic 재웜업 포함
* 세부 표: **Appendix B의 Table 3**(p.24) 요약

---

## 주요 결과

### (A) 단 두 곡선 적합으로 **여러 LRS의 전체 손실 곡선 예측**

* 20K step의 **상수+코사인** 곡선으로 적합한 뒤, 60K에서의 **상수/코사인/WSD/multi-step/cyclic** **모든 손실 곡선**을 평균 오차 \*\*≈0.2%\*\*로 예측 (p.3 Fig.2 적합, p.4 Fig.3 예측 확대)

### (B) **어닐링 시 급격한 손실 하강**의 정량화

* 어닐링 구간에서 $-C\cdot S_2$ 항의 기여가 $A\cdot S_1^{-\alpha}$보다 **지배적**→ 손실 급강하 (p.10 Fig.8)

### (C) 코사인 LRS의 **주기 길이·최소 LR 선택**

* **주기 $T=S$**, **min LR=0**가 최적(불완전/조기 어닐링의 $S_1$ 손실과 $S_2$ 이득의 균형 관점) (p.10 Fig.9)

### (D) **짧은 학습**에선 **상수 LR**이 유리, **긴 학습**에선 **코사인/어닐링** 유리

* 작은 step에서는 $\partial L/\partial S_1$가 커서 \*\*큰 LR 유지(상수 LRS)\*\*가 낫고, 충분히 크면 $\partial L/\partial S_2$가 지배→ **어닐링 전환**이 유리 (p.11 Fig.10)

### (E) **WSD와 multi-step cosine**이 전통적 코사인보다 **낮은 손실**

* 두 스케줄은 $S_2$는 약간 줄지만 **$S_1$을 크게 확보**하여 총 손실을 낮춤 (p.12 Fig.11)

### (F) WSD의 **최적 어닐링 비율**(전체 step 대비 어닐링 구간 비율)

* **포물선형** 관계로 \*\*10–20%\*\*가 대체로 최적(총 step에 의존) (p.12 Fig.12)

### (G) \*\*어닐링 함수 선택(1-sqrt vs cosine)\*\*은 **비율에 따라 바뀜**

* \*\*10%\*\*에선 1-sqrt가, \*\*50%\*\*에선 cosine이 더 우수 (예측과 실측 일치) (p.13 Fig.13)

### (H) **CPT(continual pre-training) 재웜업**:

* 재웜업 **max LR↑ → 초기 loss peak↑, 이후 더 빠른 감소**(예측 곡선으로 재현)
* **재웜업 step 수**는 **최종 손실에 영향 미미** (전구간 $S_1,S_2$ 최종값이 근접) (p.14 Fig.14)

### (I) **Chinchilla 법칙으로의 환원 및 비용 절감**

* 상수 LRS에선 식이 **그대로 환원**. 기타 LRS도 **최종점들**만 모으면 Chinchilla로 잘 적합(R²≈0.97–0.98) (p.15 Fig.15, Table 1)
* **100개 포인트** 적합 시 필요한 총 step 대비, 본 제안은 **<1% 비용**으로 충분 (p.16 Table 2)

---

## 분석 및 해석 포인트

1. **지연(Delay) 현상 = 어닐링 모멘텀**

   * LR 전환점 이후 **손실 전환점이 늦게 온다**, 경사 급할수록 지연 증가 (p.6–7 Fig.5)
   * 이를 $\lambda$로 모형화한 $S_2$가 \*\*재웜업의 손실 상승(S2<0)\*\*까지 설명

2. **$\lambda$ 선택의 의미**

   * $\lambda$↑ ⇒ **지연 step↑**, 최적 어닐링 비율↑, 1-sqrt 선호 경향↑ (p.16–17 Fig.16–17)
   * 실무적으로는 **데이터/모델에 맞춘 $\lambda$ 스윕** 권장

3. **모델 크기 확장**

   * **어닐링 이득**이 **모델 크기**와 함께 커짐($N^\gamma$) → 대규모 모델일수록 **어닐링 설계의 이익**이 큼 (p.9 Fig.7, p.29 Fig.28)

---

## 실무 가이드(체크리스트)

* **코사인 LRS**: 전체 step $S$에 **주기 $T=S$**, **min LR≈0** 권장.
* **학습 길이**가 **짧다면** 상수 LR 유지로 $S_1$ 극대화; **길다면** 어닐링 구간 확보로 $S_2$ 이득.
* **WSD**: 총 step 기준 **10–20%** 어닐링 비율이 대체로 안전한 초깃값.
* **어닐링 함수**: \*\*작은 비율(≈10%)\*\*이면 **1-sqrt**, \*\*큰 비율(≈50%)\*\*이면 **cosine** 유리.
* **CPT 재웜업**: **max LR**는 목표 최종 손실·예산에 맞춰 **곡선 예측으로 탐색**. 재웜업 **step 수 영향은 작음**.
* **대규모 모델**일수록 어닐링 이득↑ → $N$-확장식으로 스케줄을 **사전 탐색**.

---

## Figure / Table 요약(페이지 기준)

* **Fig.1 (p.2)**: $S_1$(빨강)과 $S_2$(파랑 가중 합) 시각화 — **전진** 대 **어닐링**의 균형 개념도.
* **Fig.2 (p.3)**: 상수/코사인 20K step **적합**(R²≈0.9996).
* **Fig.3 (p.4)**: 적합식으로 **미지 LRS 전체 곡선 예측**(평균오차 \~0.2%).
* **Fig.4 (p.5)**: LR/gradient norm/loss **형상 유사성**.
* **Fig.5 (p.6)**: **지연 현상** 실증(어닐링·재웜업 기울기별).
* **Fig.7 (p.9)**: **어닐링 이득이 모델 크기와 함께 증가**, $N$-확장 적합/예측 성공.
* **Fig.8–13 (p.10–13)**: **어닐링 급강하 원인**, 코사인 설정, 상수 vs 코사인 길이 효과, **WSD/멀티스텝 코사인 우위**, **최적 비율·함수**.
* **Fig.14 (p.14)**: **CPT 재웜업**: max LR/step 효과.
* **Fig.15–16 (p.15–16)**: **Chinchilla 환원**, $\lambda$ 영향.
* **Table 2 (p.16)**: **적합 비용 비교** — 본 방법 **<1%**.
* **Table 3 (p.24)**: **모든 실험 세팅 요약**.

---

## 한계점

* 식은 **경험적(phenomenological)** 모델: **기계학습 이론의 1원리 유도**는 아님.
* $\lambda$**고정**(0.999) 사용이 많아, 일부 설정에선 **적합 필요**.
* $S_2<0$(재웜업)에서 **지수/멱 보정** 같은 대안형(부록 6.3)도 시험했으나 **개선 미미**.
* **검증 손실–다운스트림 성능**의 대응은 일반적으로 강하나 **완벽한 보증은 아님**.
* **데이터 분포 이동**은 제한적 고려(CPT에서 LR 효과가 주도, 분포효과는 2차적 가정).

---

## 향후 연구 방향

* **식 구조 추가 튜닝**(예: $S_2^\zeta$, LR-가중 계수)과 $\lambda$ **공동 적합** 자동화
* \*\*후처리(post-training)\*\*와 **정렬/도메인 이동**까지 확장
* **스케줄 자동 탐색기**: 제안식을 목적함수로 사용해 **비용 없이 최적 LRS 설계**

---

## Appendix 요약

### Appendix A — Warmup 영향 (p.23)

* warmup **500 step**이 수렴을 가속하고 **최종 손실 최소화**(0/100/500 비교).

### Appendix B — 실험 설정 총괄표 (p.24, Table 3)

* A–E 다섯 설정(모델 크기·데이터·시퀀스 길이·배치·LR·토크나이저·MoE 옵션 등) 정리.

### Appendix C — 광범위 검증 (p.25–28)

* **다른 하이퍼파라미터**(Setting B), **MoE**(Setting D), **장기 350K step/1.7B**(Setting E) 예측 성공.
* **BLOOM-176B**, **OLMo-1B(2T tokens)** 공개 곡선에도 높은 적합(R²≥0.996).

### Appendix D — WSD 정의 및 어닐링 함수 (p.26, p.29)

* **WSD 수식**과 **1-sqrt / 1-square / cosine** 정의 및 LR 곡선 비교 도표.

---

## 결론 및 시사점

* **한 식**으로 다양한 LRS의 **학습 전 구간 손실 곡선**을 정확히 기술·예측.
* \*\*전진 면적 $S_1$\*\*과 \*\*어닐링 면적 $S_2$\*\*의 **정량적 균형**이 손실 최적화의 본질.
* **코사인 $T=S$, min LR≈0**, **WSD 10–20%**, **짧은 학습=상수 LR**, **큰 모델일수록 어닐링 이득↑** 등 **실무 규칙**을 이론적으로 해명.
* **스케일링 법칙 민주화**: **극소 비용**으로도 정밀한 스케일링/스케줄 설계가 가능.

---

*도해·수식·표 및 모든 수치·주장은 원문 도표/부록을 근거로 정리했습니다(예: p.2 Fig.1, p.3 Fig.2, p.4 Fig.3, p.10 Fig.9, p.12 Fig.12, p.16 Table 2, p.24 Table 3 등).*&#x20;
